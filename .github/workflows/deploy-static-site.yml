name: Build and Deploy to GCS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    # Add 'id-token' with 'write' permission for authenticating to GCP
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Use a specific LTS version
        cache: 'npm'

    - name: Install Dependencies
      run: npm install

    - name: Build Static Site
      run: npm run build

    - name: Authenticate to Google Cloud
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
        service_account: '${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}' # e.g. my-service-account@my-project.iam.gserviceaccount.com
        # The project_id is required by some downstream actions.
        # In our setup, the GCS bucket name is the same as the project ID.
        project_id: '${{ secrets.GCP_BUCKET_NAME }}'
    
    - name: Deploy to Google Cloud Storage
      id: deploy
      uses: 'google-github-actions/upload-cloud-storage@v2.2.0'
      with:
        parent: false
        path: 'out' # The directory produced by `next build` with `output: 'export'`
        destination: '${{ secrets.GCP_BUCKET_NAME }}' # The GCS bucket to deploy to
        glob: '**' # Upload all files in the source directory

    - name: Create Deployment Summary
      run: |
        echo "## Deployment Successful ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**View live site:** https://storage.googleapis.com/${{ secrets.GCP_BUCKET_NAME }}/index.html" >> $GITHUB_STEP_SUMMARY 